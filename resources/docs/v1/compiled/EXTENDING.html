<h1>Extending FlexiCart</h1>
<p>FlexiCart is designed to be extended. You can create custom conditions, storage drivers, and integrate with your existing models.</p>
<h2>Custom Condition Classes</h2>
<p>Create custom condition types by extending the base <code>Condition</code> class:</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">&lt;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">App\Cart\Conditions</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Conditions\Condition</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Enums\ConditionType</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Price</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">BuyOneGetOneCondition</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">extends</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Condition</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">ConditionType</span><span style="color:#E1E4E8"> $type </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">ConditionType</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PERCENTAGE</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">calculate</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">?</span><span style="color:#79B8FF">Price</span><span style="color:#E1E4E8"> $price </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Price</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#6A737D">// Custom calculation logic</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#6A737D">// For example, buy one get one 50% off</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">attributes</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">quantity </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            $discount </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $price</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">multipliedBy</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0.5</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> $discount</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">multipliedBy</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// Negative for discount</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Price</span><span style="color:#F97583">::</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">formattedValue</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;Buy One Get One 50% Off&#39;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3>Usage</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">App\Cart\Conditions\BuyOneGetOneCondition</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Enums\ConditionTarget</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">$condition </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">BuyOneGetOneCondition</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;BOGO Deal&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">50</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">target</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">ConditionTarget</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ITEM</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItemCondition</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;item-123&#39;</span><span style="color:#E1E4E8">, $condition);</span></span>
<span class="line"></span></code></pre>
<h2>Custom Storage Drivers</h2>
<p>Implement custom storage by creating a class that implements <code>StorageInterface</code>:</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">&lt;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">App\Cart\Storage</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Contracts\StorageInterface</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Illuminate\Support\Facades\Redis</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">RedisCartStorage</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">implements</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">StorageInterface</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">protected</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> $prefix </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;cart:&#39;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> $key)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">array</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        $data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Redis</span><span style="color:#F97583">::</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">prefix </span><span style="color:#F97583">.</span><span style="color:#E1E4E8"> $key);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> $data </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">json_decode</span><span style="color:#E1E4E8">($data, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> $key, </span><span style="color:#F97583">array</span><span style="color:#E1E4E8"> $data)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">void</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">Redis</span><span style="color:#F97583">::</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">prefix </span><span style="color:#F97583">.</span><span style="color:#E1E4E8"> $key,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#79B8FF">json_encode</span><span style="color:#E1E4E8">($data),</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;EX&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#79B8FF">60</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">60</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">24</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8"> </span><span style="color:#6A737D">// 1 week TTL</span></span>
<span class="line"><span style="color:#E1E4E8">        );</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">forget</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> $key)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">void</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">Redis</span><span style="color:#F97583">::</span><span style="color:#B392F0">del</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">prefix </span><span style="color:#F97583">.</span><span style="color:#E1E4E8"> $key);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">flush</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">void</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        $keys </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Redis</span><span style="color:#F97583">::</span><span style="color:#B392F0">keys</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">prefix </span><span style="color:#F97583">.</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;*&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#79B8FF">empty</span><span style="color:#E1E4E8">($keys)) {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#79B8FF">Redis</span><span style="color:#F97583">::</span><span style="color:#B392F0">del</span><span style="color:#E1E4E8">($keys);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3>Registering Custom Storage</h3>
<p>Configure in <code>config/flexicart.php</code>:</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#9ECBFF">&#39;storage_class&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">App\Cart\Storage\RedisCartStorage</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">,</span></span>
<span class="line"></span></code></pre>
<h2>Custom Models</h2>
<p>When using database storage, extend the default models:</p>
<h3>Custom Cart Model</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">&lt;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">App\Models</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Models\Cart</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">BaseCart</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Cart</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">extends</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">BaseCart</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">protected</span><span style="color:#E1E4E8"> $appends </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">&#39;formatted_total&#39;</span><span style="color:#E1E4E8">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">user</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">belongsTo</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">User</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">getFormattedTotalAttribute</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">total</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">formatted</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#6A737D">// Add custom scopes</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">scopeAbandoned</span><span style="color:#E1E4E8">($query)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> $query</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;updated_at&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;&lt;&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">subDays</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3>Custom CartItem Model</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">&lt;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">App\Models</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Models\CartItem</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">BaseCartItem</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">CartItem</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">extends</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">BaseCartItem</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">product</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">belongsTo</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Product</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;item_id&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">getImageUrlAttribute</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">?string</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">product</span><span style="color:#F97583">?-&gt;</span><span style="color:#E1E4E8">image_url;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3>Configuration</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#6A737D">// config/flexicart.php</span></span>
<span class="line"><span style="color:#9ECBFF">&#39;cart_model&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">App\Models\Cart</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">&#39;cart_item_model&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">App\Models\CartItem</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">,</span></span>
<span class="line"></span></code></pre>
<h2>Custom Rules</h2>
<p>For complex promotional logic, create custom rules. See <a href="RULES_ENGINE.md">Rules Engine</a> for detailed documentation.</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">&lt;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">App\Cart\Rules</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Conditions\Rules\AbstractRule</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Enums\ConditionType</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Price</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FirstTimeCustomerRule</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">extends</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">AbstractRule</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">__construct</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">string</span><span style="color:#E1E4E8"> $name,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">readonly</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">float</span><span style="color:#E1E4E8"> $discountPercent,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">readonly</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">bool</span><span style="color:#E1E4E8"> $isFirstOrder </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">false</span></span>
<span class="line"><span style="color:#E1E4E8">    ) {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">parent::</span><span style="color:#B392F0">__construct</span><span style="color:#E1E4E8">($name, $discountPercent);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">type </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">ConditionType</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PERCENTAGE</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">applies</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">bool</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">isFirstOrder;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">getDiscount</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Price</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">applies</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Price</span><span style="color:#F97583">::</span><span style="color:#B392F0">zero</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        $discountAmount </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">subtotal</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">multiplyBy</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">discountPercent </span><span style="color:#F97583">/</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Price</span><span style="color:#F97583">::</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">$discountAmount</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toFloat</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2>Custom Merge Strategies</h2>
<p>Create custom merge behavior by implementing <code>MergeStrategyInterface</code>:</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">&lt;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">App\Cart\Strategies</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\CartItem</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Strategies\MergeStrategyInterface</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Illuminate\Support\Collection</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">AverageMergeStrategy</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">implements</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">MergeStrategyInterface</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">name</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">string</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;average&#39;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">mergeItem</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">CartItem</span><span style="color:#E1E4E8"> $targetItem, </span><span style="color:#79B8FF">CartItem</span><span style="color:#E1E4E8"> $sourceItem)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">array</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#6A737D">// Average the quantities</span></span>
<span class="line"><span style="color:#E1E4E8">        $avgQuantity </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) </span><span style="color:#79B8FF">ceil</span><span style="color:#E1E4E8">(($targetItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">quantity </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">quantity) </span><span style="color:#F97583">/</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $targetItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">id,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">name,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">unitPrice</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $avgQuantity,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;taxable&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">taxable,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;attributes&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">attributes</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toArray</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">        ];</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handleNewItem</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">CartItem</span><span style="color:#E1E4E8"> $sourceItem)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">array</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">id,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">name,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">unitPrice</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">quantity,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;taxable&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">taxable,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#9ECBFF">&#39;attributes&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $sourceItem</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">attributes</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toArray</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">        ];</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">mergeConditions</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Collection</span><span style="color:#E1E4E8"> $targetConditions, </span><span style="color:#79B8FF">Collection</span><span style="color:#E1E4E8"> $sourceConditions)</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Collection</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> $targetConditions</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">merge</span><span style="color:#E1E4E8">($sourceConditions);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3>Register the Strategy</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Strategies\MergeStrategyFactory</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">App\Cart\Strategies\AverageMergeStrategy</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// In a service provider</span></span>
<span class="line"><span style="color:#79B8FF">MergeStrategyFactory</span><span style="color:#F97583">::</span><span style="color:#B392F0">register</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;average&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">AverageMergeStrategy</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Usage</span></span>
<span class="line"><span style="color:#E1E4E8">$cart</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">mergeFrom</span><span style="color:#E1E4E8">($sourceCart, </span><span style="color:#9ECBFF">&#39;average&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span></code></pre>
<h2>Event Listeners</h2>
<p>Hook into cart lifecycle events for analytics, inventory, notifications, etc. See <a href="EVENTS.md">Events</a> for complete documentation.</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#6A737D">// app/Providers/EventServiceProvider.php</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Events\ItemAdded</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Events\CartCleared</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">protected</span><span style="color:#E1E4E8"> $listen </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">ItemAdded</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">App\Listeners\ReserveInventory</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">App\Listeners\TrackAddToCart</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ],</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">CartCleared</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">App\Listeners\ReleaseInventory</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ],</span></span>
<span class="line"><span style="color:#E1E4E8">];</span></span>
<span class="line"></span></code></pre>
<h2>Service Container Bindings</h2>
<p>Override FlexiCart services via the container:</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#6A737D">// app/Providers/AppServiceProvider.php</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Contracts\StorageInterface</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">App\Cart\Storage\RedisCartStorage</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">register</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">app</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">bind</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">StorageInterface</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">RedisCartStorage</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2>Macros</h2>
<p>Add methods to the Cart class at runtime:</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Cart</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// In a service provider</span></span>
<span class="line"><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">macro</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;hasPromoCode&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">conditions</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">contains</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> ($c) =&gt; </span><span style="color:#79B8FF">str_starts_with</span><span style="color:#E1E4E8">($c</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">name, </span><span style="color:#9ECBFF">&#39;PROMO:&#39;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Usage</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">hasPromoCode</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#6A737D">// ...</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2>Testing FlexiCart</h2>
<h3>Testing Custom Extensions</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Facades\Cart</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">App\Cart\Conditions\BuyOneGetOneCondition</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;bogo condition applies correctly&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItem</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;shirt-1&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;T-Shirt&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">20.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    $item </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">item</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;shirt-1&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItemCondition</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;shirt-1&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">BuyOneGetOneCondition</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;BOGO&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">50</span></span>
<span class="line"><span style="color:#E1E4E8">    ));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#6A737D">// With BOGO 50% off on 2 items ($40 total), discount should be $10</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">($item</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">total</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toFloat</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">30.00</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h3>Resetting the Cart Between Tests</h3>
<p>Always reset the cart between tests to ensure a clean state:</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Facades\Cart</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">beforeEach</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">reset</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;cart starts empty&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">isEmpty</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBeTrue</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h3>Testing Cart Operations</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Facades\Cart</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;can add items to cart&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItem</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;product-1&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;Test Product&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">25.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">uniqueCount</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">subtotal</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toFloat</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">50.00</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;can update item quantity&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItem</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;product-1&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;Test Product&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">25.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">updateItem</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;product-1&#39;</span><span style="color:#E1E4E8">, [</span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;can apply discount condition&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItem</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;product-1&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;Test Product&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">100.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addCondition</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">PercentageCondition</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;10% Off&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">-</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">target</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">ConditionTarget</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SUBTOTAL</span></span>
<span class="line"><span style="color:#E1E4E8">    ));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">total</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toFloat</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">90.00</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h3>Testing with Events</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Facades\Cart</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Events\ItemAdded</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Illuminate\Support\Facades\Event</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;dispatches event when item is added&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Event</span><span style="color:#F97583">::</span><span style="color:#B392F0">fake</span><span style="color:#E1E4E8">([</span><span style="color:#79B8FF">ItemAdded</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItem</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;product-1&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;Test Product&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">25.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Event</span><span style="color:#F97583">::</span><span style="color:#B392F0">assertDispatched</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">ItemAdded</span><span style="color:#F97583">::class</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> ($event) {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> $event</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">item</span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8">id </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;product-1&#39;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h3>Testing Rules</h3>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Facades\Cart</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Conditions\Rules\ThresholdRule</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Enums\ConditionType</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;threshold rule applies when subtotal met&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItem</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;product-1&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;Expensive Item&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">150.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addRule</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">ThresholdRule</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;Spend $100 Save 10%&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">minSubtotal</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">100.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">discount</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">-</span><span style="color:#79B8FF">10.0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">discountType</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">ConditionType</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PERCENTAGE</span></span>
<span class="line"><span style="color:#E1E4E8">    ));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#6A737D">// $150 - 10% = $135</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">total</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toFloat</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">135.00</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;threshold rule does not apply when subtotal not met&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addItem</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;product-1&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&#39;Cheap Item&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;price&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">50.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#9ECBFF">&#39;quantity&#39;</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">addRule</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">ThresholdRule</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;Spend $100 Save 10%&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">minSubtotal</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">100.00</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">discount</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">-</span><span style="color:#79B8FF">10.0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">discountType</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">ConditionType</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PERCENTAGE</span></span>
<span class="line"><span style="color:#E1E4E8">    ));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#6A737D">// Rule doesn&#39;t apply, still $50</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">total</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toFloat</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">50.00</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h3>Mocking the Cart Facade</h3>
<p>For unit testing code that uses the Cart:</p>
<pre class="shiki" style="background-color: #24292e"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Facades\Cart</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Daikazu\Flexicart\Price</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;checkout calculates correct total&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">shouldReceive</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;total&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">once</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">andReturn</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">Price</span><span style="color:#F97583">::</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">99.99</span><span style="color:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">Cart</span><span style="color:#F97583">::</span><span style="color:#B392F0">shouldReceive</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;items&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">once</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">andReturn</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">collect</span><span style="color:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#6A737D">// Test your checkout logic here</span></span>
<span class="line"><span style="color:#E1E4E8">    $checkout </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">CheckoutService</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">($checkout</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">getTotal</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">-&gt;</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">99.99</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
